%#!platex main.tex
%#BIBTEX pbibtex main

\section{行動}

ToDo:論理学の用語がほとんどわからないので少し調べる。
$R = 14$とする。二重否定則を採用する。
無限は絡まないので選択公理等はどうでもいいはず。

\subsection{「ならば」の変換}

SAT Solver に投げる命題に条件を落とし込むときに、
「ならば」で発想すると自然に記述できるように思う。
ところが「ならば」は SAT Solver には直接入力はできない。
そこで「ならば」の変換に必要な補題を用意する。

\begin{lem} \label{lem:land_lor}
 $a, b, c$を真か偽かの変数とする。以下が成立する。
 \[
 (a \land b) \lor c = (a \lor c) \land (b \lor c).
 \]
\end{lem}

\begin{proof}
 もっとかっこいい方法があるかもしれないが、私は$(a, b, c)$の
 真偽$8$パターンを確かめた。
 $a$が真のときと
 $(a, b, c) = (\text{真}, \text{真}, \text{偽})$のときは両辺真、
 残りは偽である。\qedhere
\end{proof}

\begin{cor} \label{cor:rightarrow}
 $a, b$を真か偽かの変数とする。以下が成立する。
 \[
  a \Rightarrow b = (\lnot a \lor b).
 \]
\end{cor}

\begin{proof}
 $a \Rightarrow b$は$\lnot a \lor (a \land b)$と同値である。
 あとは補題~\ref{lem:land_lor}を用いると、次式がしたがう。
 \[
  \lnot a \lor (a \land b) = (\lnot a \lor a) \land (\lnot a \lor b)
 = (\lnot a \lor b). \qedhere
 \]
\end{proof}

\subsection{行動した「地点」に関する入力}

ここでは、行動開始地点、行動終了地点、塗った地点に関する
基本的な条件を落とし込む。実際にフィールドを見て
それらを決定するプロセスは次小節にまわす。

まずは、行動地点に関する変数を導入する。

\begin{nota}
 $0 \leq i, j \leq R$とする。$k = 0, 1, 2 ,3$とする。
 \begin{enumerate}[1.]
  \item $s_{ij}$を「$i$行$j$列が行動開始地点ならば真、そうでないならば偽」とする。
  \item $e_{ij}$を「$i$行$j$列が行動終了地点ならば真、そうでないならば偽」とする。
  \item $d_{ijk}$を「$i$行$j$列方角$k$で塗ったならば真、そうでないならば偽」とする。
 \end{enumerate}
\end{nota}

\begin{rem} \label{rem:kumiawase}
 $1$ターン内にできる敵の行動は、顕現・隠伏の違いを除けば
 真である$s_{ij}$、$e_{ijk}$、$d_{ijk}$の組み合わせに対応する。
\end{rem}

最初に、当然だが、どこかの地点で行動開始、どこかの地点で塗り、どこかの地
点で行動終了していないといけない。これらの条件はそれぞれ
\begin{align*}
 (\text{Allow})_s &= \bigvee_{i = 0}^R \bigvee_{j = 0}^R s_{ij}, \\
 (\text{Allow})_e &= \bigvee_{i = 0}^R \bigvee_{j = 0}^R e_{ij}, \\
 (\text{Allow})_d &=
 \bigvee_{i = 0}^R \bigvee_{j = 0}^R \bigvee_{j = 0}^3 d_{ijk}
\end{align*}
と表せる。

次に、これも当然なことだが、$2$つ以上のマスが行動開始地点であってはならな
い。このことは SAT Solver に明示的に入力される必要がある。
つまり、全ての$(i, j) \neq (k, l)$に対し、
$\lnot (s_{ij} \land s_{kl})$である。すなわち、
\[
 (\text{Forbid})_s = 
 \bigwedge_{(i, j) \neq (k, l)} \lnot
 (s_{ij} \land s_{kl})
\]
である。これを SAT の入力に合うように変形すると、
\begin{align*}
 (\text{Forbid})_s &= \bigwedge_{(i, j) \neq (k, l)} (\lnot
 s_{ij} \lor \lnot s_{kl}) 
\end{align*}
である。これは$e, d$も同様である。すなわち、
\begin{align*}
 (\text{Forbid})_e &= \bigwedge_{(i, j) \neq (k, l)} (\lnot
 e_{ij} \lor \lnot e_{kl}), \\
 (\text{Forbid})_d &= \bigwedge_{(i, j, k) \neq (l, m, n)} (\lnot
 e_{ijk} \lor \lnot e_{lmn})
\end{align*}
である。

次に、移動はせいぜい$1$マスしかできないことを条件に加える。
$k, l$はそれぞれ$0$以上$R$以下とする。
しばらく、点$(k, l)$から
$0$または$1$しか離れていないマス$(i, j)$について$\bigvee$をとった
ものを$\bigvee_{i, j}$と表記することにする。素朴には
\[
 \bigvee_{i, j} = \bigvee_{i = k-1}^{k+1} \bigvee_{i = l-1}^{l+1} 
\]
のことだが、$(k, l)$が端のマスだったら$(i, j)$はフィールドの
外かもしれない。その部分は実装の際に適宜外すことにする。

さて、行動開始地点が点$(k, l)$のとき、行動終了地点が
せいぜい$1$マスしか離れていないことは、任意の$(k, l)$に対して
\[
 s_{kl} \Rightarrow \left( \bigvee_{i, j} e_{ij} \right)
\]
であると書ける。補題~\ref{cor:rightarrow}より、これは
\[
 \lnot s_{kl} \lor \left( \bigvee_{i, j} e_{ij} \right)
\]
と同値である。$(k, l)$について$\bigwedge$をとって、
\[
 (\text{start-end}) = \bigwedge_{k = 0}^R \bigwedge_{l = 0}^R 
 \left(\lnot s_{kl} \lor \left( \bigvee_{i, j} e_{ij} \right) \right)\
\]
が求める条件である。

次に塗った位置と方角についての条件を書く。つまり「塗った位置は、開始地点
か終了地点である」ということである。すなわち、任意の$(i, j, k)$に対し、
\[
 d_{ijk} \Longrightarrow s_{ij} \lor e_{ij}
\]
である。補題~\ref{cor:rightarrow}より、これは
\[
 \lnot d_{ijk} \lor (s_{ij} \lor e_{ij})
\]
と同値である。すなわち、条件は
\[
 (\text{drawpoint}) =
 \bigwedge_{i = 0}^{R} \bigwedge_{j = 0}^R \bigwedge_{k = 0}^3
 (\lnot d_{ijk} \lor s_{ij} \lor e_{ij})
\]
である。

\begin{rem}
 ここまでの制約をまとめると、以下の通りである。
 \begin{itemize}
  \item 行動開始地点と行動終了地点がただ$1$つ存在する。
  \item 行動開始地点と行動終了地点はせいぜい$1$マスしか離れていない。
  \item 塗った地点と塗った方向がただ$1$つ存在する。
  \item 塗った地点は、行動開始地点または行動終了地点である。
 \end{itemize}
\end{rem}

\subsection{塗った地点の制約}

ここから先は、各ターン毎のフィールドの状況を鑑みて、
$d_{ijk}$に制限を加える。以下では、
$0 \leq i, j \leq R$、および、$k = 0, 1, 2, 3$は固定する。

以下では、次の前提を置く。
\begin{itemize}
 \item SAT Solver を使って敵の位置を特定するのは、
       直前のターンのフィールドの状況と現在のフィールドの状況を
       見比べた際に、ある地点の色が敵軍の武将の色に変化したことを
       確認したとき、および、そのときのみとする。
 \item 変化後の色を持った武将を、以下では単に\emph{敵}と呼ぶ。
\end{itemize}

この前提をもとに、フィールドの状況を SAT Solver に入力する
変数を用意する。
\begin{nota}[フィールドからの制約変数] \label{nota:field_var}
 $0 \leq l, m \leq R$とする。
 \begin{enumerate}[1.]
  \item $\alpha_{lm}$を「点$(l, m)$が知覚されており、かつ、
        現在敵の色で塗られているなら真、
        そうでないなら偽」
        とする。より具体的に言うと、点$(l, m)$が
        味方軍の色、あるいは、敵以外の敵軍の色で塗られ
        ている場合、ないしは、点$(l, m)$をの色を知覚できない場合を偽とする。
  \item $\beta_{lm}$を「点$(l, m)$が知覚されており、かつ、
        現在敵の色で塗られていないなら真、
        そうでないなら偽」
        とする。より具体的に言うと、点$(l, m)$が
        敵の色で塗られている場合、
        ないしは、点$(l, m)$をの色を知覚できない場合を偽とする。
  \item $\gamma_{lm}$を「点$(l, m)$を敵が直前に塗ったことが確実ならば真、
        そうでないなら偽」とする。つまり、現在敵の色で塗られているものの
        敵の行動の直前は敵の色で塗られていない場合に真とし、
        それ以外は偽とする。
  \item $\delta_{lm}$を「点$(l, m)$を敵が直前に塗らなかったことが
        確実ならば真、そうでないなら偽」とする。
        つまり、現在敵の色以外で塗られており、
        敵の行動の直前も同じ色で塗られていた場合は真とし、
        それ以外は偽とする。
 \end{enumerate}
\end{nota}

\begin{rem}
 記号~\ref{nota:field_var}の
 $\alpha_{lm}$、$\beta_{lm}$、$\gamma_{lm}$、$\delta_{lm}$は全て
 SAT Solver に真か偽かを入力するものとする。
 例えば、$\alpha_{lm}$が真である場合には$1$つのリテラルからなる節
 $\alpha_{lm}$を、偽である場合には$1$つのリテラルからなる節
 $\lnot \alpha_{lm}$を入力する。
\end{rem}

さて、塗ったときの敵の地点と方向は$d_{ijk}$で表現されているが、
この情報を塗ったマスの情報に予めおきかえておくことが以下では必要になる。
つまり、以下で定義する変数$g_{lm}$を媒介して、
$d_{ijk}$ではなく$g_{lm}$で制約を記述する。

\begin{nota}[塗った地点の情報を媒介する変数] \label{nota:params_d_g}
 \begin{enumerate}[1.]
  \item 敵が$(i, j)$の地点で方角$k$に塗ったときに塗られる地点の集合を
        $D_{ijk}$とする。
  \item $0 \leq l, m \leq R$とする。
        $g_{lm}$を「点$(l, m)$が敵が直前の行動で塗った地点ならば真、そう
        でないならば偽」とする。
 \end{enumerate}
\end{nota}

\begin{rem}
 ここでは敵は固定されているので、$D_{ijk}$は$(i, j, k)$の組により
 一意に定まる。
\end{rem}

\begin{rem} 
 $g_{lm}$は、どの$d_{ijk}$が成立するかで真か偽かが決まるのであり、
 フィールドの情報とは関係がないことに注意されたい。
 $g_{lm}$とフィールドの情報$\beta_{lm}$、$\gamma_{lm}$、
 $\delta_{lm}$との整合性の条件式を以下で与える。
 これにより、$g$を媒介としてフィールドの情報から$d$に制約を
 与えることができる。
\end{rem}

さてまず、$d_{ijk}$の情報を$g_{lm}$の情報に置き換える条件式を書く。
これは記号~\ref{nota:params_d_g}より、
\[
 d_{ijk} \Rightarrow \left( \bigwedge_{(l, m) \in D_{ijk}} g_{lm} \right)
 \land \left( \bigwedge_{(l, m) \not\in D_{ijk}} \lnot g_{lm} \right)
\]
である。系~\ref{cor:rightarrow}より、
\[
 \lnot d_{ijk} \lor 
 \left(
 \left( \bigwedge_{(l, m) \in D_{ijk}} g_{lm} \right)
 \land \left( \bigwedge_{(l, m) \not\in D_{ijk}} \lnot g_{lm} \right)
 \right)
\]
と同値である。補題~\ref{lem:land_lor}及び
$(i, j, k)$が固定されていたことを考慮すると、
求める条件は
\begin{equation}
 (\text{param-trans}) = \bigwedge_{i, j, k} \left(
                            \left( \bigwedge_{(l, m) \in D_{ijk}}
                             (\lnot d_{ijk} \lor g_{lm}) \right)
                            \land
                            \left( \bigwedge_{(l, m) \not\in D_{ijk}}
                             (\lnot d_{ijk} \lor \lnot g_{lm}) \right)
                           \right)
\end{equation}
である。

次に、$\beta_{ij}$、$\gamma_{ij}$、$\delta_{ij}$と
$g_{ij}$の関係式を導く。次の関係がある。
\begin{enumerate}
 \item 敵が直前に塗り替えたことが確実な点は、敵が塗った点である。
 \item 敵が塗った点は、敵の色でぬられた点、または、知覚できていない点である。
 \item 敵が直前に塗り替えなかったことが確実な点は、敵が塗った点ではない。
\end{enumerate}
言うまでもなくこれらは、任意の$l, m$に対して以下が成立することを
意味している。
\begin{enumerate}
 \item $\gamma_{lm} \Rightarrow g_{lm}$。
 \item $g_{lm} \Rightarrow \lnot \beta_{lm}$。
 \item $\delta_{lm} \Rightarrow \lnot g_{lm}$。
\end{enumerate}
補題~\ref{lem:land_lor}、系~\ref{cor:rightarrow}より、
以下が得られる。
\begin{align*}
 (\text{field})_\gamma &=
 \bigwedge_{l = 0}^R  \bigwedge_{m = 0}^R (\lnot \gamma_{lm} \lor
 g_{ij}), \\
 (\text{field})_\beta &=
 \bigwedge_{l = 0}^R  \bigwedge_{m = 0}^R (\lnot g_{lm} \lor
 \lnot \beta_{ij}), \\
 (\text{field})_\delta &=
 \bigwedge_{l = 0}^R  \bigwedge_{m = 0}^R (\lnot \delta_{lm} \lor
 \lnot g_{ij}).
\end{align*}

\subsection{隠遁・顕現の条件}

\begin{defn}
 $\{s_{ij} \}_{ij}$、$\{e_{ij} \}_{ij}$、
 $\{d_{ijk} \}_{ijk}$は、前節までの条件をみたすものとする。
 \begin{enumerate}[1.]
  \item 真である$s_{ij}$、$e_{ij}$、$d_{ijk}$の組み合わせを\emph{行動}
        と呼ぶ。特にどの元が真であるのかを問題としない場合は
        $(s, e, d)$とも記す。
  \item ある行動が\emph{行動可能}であるとは、その行動が$1$ターンのコスト
        内で行動可能であることをいう。
 \end{enumerate}
\end{defn}

注意~\ref{rem:kumiawase}でも指摘した通り、
$(s, e, d)$の組み合わせは、ルール上の意味での「敵の$1$ターンの行動」に対応する。
前小節までで、隠遁と顕現の条件以外の制約を考慮に入れた。
本小節では、隠遁と顕現の条件からありえない組み合わせを排除し、
その行動が行動可能であることを保証する。

\begin{nota} \label{nota:r_s}
 \begin{enumerate}
  \item $r_0$を、開始地点で隠伏状態であるならば真、そうでないならば偽とする。
  \item $r_1$を、終了地点で隠伏状態であるならば真、そうでないならば偽と
        する。
  \item $r_2$を、開始地点と終了地点が異なっているならば真、そうでないな
        らば偽とする。
 \end{enumerate}
\end{nota}

\begin{prop} \label{prop:kengen_inpuku}
 ある行動が行動可能であるための条件は、以下の節が真であることである。
 \begin{equation}
  (\text{movable}) = \lnot r_0 \lor \lnot r_1 \lor \lnot r_2.
 \end{equation}
\end{prop}

\begin{proof}
 ある行動がコスト$7$以内である条件を
 現在の状況では
\end{proof}

\begin{rem}
 記号~\ref{nota:r_s}で定められた$r_0, r_1, r_2$は、
 隠伏状態であるかないかが判明しない場合は、考慮に入れないことにする。
 しかしこの場合、命題~\ref{prop:kengen_inpuku}により、
 その変数は自動的に偽となる。
\end{nota}


\begin{rem}
 記号~\ref{nota:r_s}で定められた$r_0, r_1, r_2$は、
 
\end{rem}

% Local Variables:
% mode: yatex
% coding: utf-8
% TeX-master: "main.tex"
% End:
